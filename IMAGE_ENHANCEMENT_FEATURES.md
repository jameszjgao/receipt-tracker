# 图像增强功能说明

## 功能概述

应用已集成自动裁剪和图像质量调整功能，使用纯 JavaScript 实现，无需原生模块。这些功能在开发构建中可用，但不支持在 Expo Go 中测试。

## 已实现的功能

### 1. 自动裁剪

- **功能**：自动检测文档边缘并裁剪，去除图片边缘的空白区域
- **实现方式**：简化的边缘检测算法，自动去除图片边缘 5% 的边距
- **适用场景**：拍摄小票时，自动去除背景，聚焦文档内容

### 2. 图像质量优化

- **压缩优化**：智能压缩，在保持质量的同时减小文件大小
- **尺寸调整**：自动调整图片尺寸，最大不超过 2048x2048
- **格式统一**：统一转换为 JPEG 格式，确保兼容性

### 3. 亮度/对比度调整（间接实现）

- **当前实现**：通过优化压缩质量来间接改善图像效果
- **说明**：`expo-image-manipulator` 不直接支持亮度和对比度调整
- **未来优化**：可以通过以下方式实现真正的亮度/对比度调整：
  - 服务端处理（在 Gemini 识别前处理）
  - 使用原生模块（需要开发构建）
  - 使用 Canvas API（如果可用）

## 使用方法

### 在相机拍摄时

功能已自动启用，拍摄照片时会自动应用：
- ✅ 自动裁剪（去除 5% 边距）
- ✅ 图像质量优化
- ✅ 智能压缩

### 从相册选择时

功能也已自动启用，选择图片时会自动应用相同的处理。

## 技术实现

### 核心文件

- `lib/image-processor.ts` - 图像处理核心逻辑
  - `processImageForUpload()` - 主处理函数
  - `enhanceImage()` - 图像增强函数
  - `detectEdges()` - 边缘检测函数

### 处理流程

1. **边缘检测**：检测文档边缘（当前使用简化的中央裁剪算法）
2. **自动裁剪**：根据检测结果裁剪图片
3. **尺寸调整**：如果图片过大，按比例缩小
4. **质量压缩**：智能压缩，确保文件大小合适
5. **格式转换**：统一转换为 JPEG 格式

## 配置选项

可以在 `app/camera.tsx` 中调整处理参数：

```typescript
await processImageForUpload(imageUri, {
  autoCrop: true,        // 是否启用自动裁剪
  brightness: 0.1,       // 亮度调整（当前通过压缩质量间接实现）
  contrast: 0.15,        // 对比度调整（当前通过压缩质量间接实现）
  quality: 0.85,         // 输出质量 (0-1)
});
```

## 注意事项

1. **Expo Go 限制**：这些功能需要在开发构建中测试，不支持 Expo Go
2. **性能考虑**：图像处理会消耗一定时间，已优化为异步处理，不阻塞 UI
3. **边缘检测**：当前使用简化的算法，未来可以集成更高级的边缘检测
4. **亮度/对比度**：当前通过压缩质量间接实现，真正的调整需要服务端或原生模块

## 未来优化方向

1. **更精确的边缘检测**：使用图像处理算法或 AI 模型
2. **真正的亮度/对比度调整**：集成原生模块或服务端处理
3. **透视矫正**：自动纠正拍摄角度导致的变形
4. **智能锐化**：提高文字清晰度
