# Snap Receipt - 功能说明文档

## 应用简介

**Snap Receipt** 是一个基于 React Native + Expo 开发的家庭记账应用，支持拍摄消费小票，使用 Google Gemini AI 自动识别并整理成明细，帮助家庭轻松管理日常开支。

---

## 核心功能

### 1. 小票识别与录入 📸

#### 1.1 拍摄小票
- **相机拍摄**：使用设备相机直接拍摄小票照片
- **相册选择**：从手机相册中选择已有的小票图片
- **即时上传**：拍摄后自动上传到云端存储（Supabase Storage）

#### 1.2 AI 智能识别
- **自动识别**：使用 Google Gemini 1.5 Pro AI 模型自动识别小票内容
- **识别内容**：
  - 店铺名称
  - 消费日期
  - 总金额
  - 商品明细（名称、价格、数量）
  - 支付账户
- **置信度评估**：系统为每个识别结果提供置信度评分（0.00-1.00）

#### 1.3 智能确认与编辑
- **低置信度提示**：当识别置信度较低时，系统会提示用户确认信息
- **手动编辑**：用户可以编辑和修正所有识别结果
- **商品管理**：
  - 修改商品名称、价格
  - 调整商品分类
  - 设置商品用途（个人/商务）
  - 标记是否为资产
  - 添加/删除商品项

#### 1.4 手动录入
- **快速录入**：支持手动输入小票信息，无需拍照
- **表单录入**：通过表单填写店铺名称、日期、金额等信息
- **商品添加**：可以手动添加商品明细

---

### 2. 小票管理 📊

#### 2.1 小票列表
- **时间分组**：小票按月份分组显示，便于查看
- **状态筛选**：
  - 待确认 (Pending) - 需要用户确认
  - 处理中 (Processing) - 正在处理
  - 已确认 (Confirmed) - 已完成
  - 需重拍 (Needs Retake) - 识别失败
  - 重复 (Duplicate) - 检测到重复小票
- **搜索功能**：支持按店铺名称、金额等关键词搜索
- **实时同步**：使用 Supabase Realtime 实时同步数据变更

#### 2.2 小票详情
- **完整信息展示**：查看小票的所有详细信息
- **原图查看**：查看小票原始照片
- **在线编辑**：在详情页直接编辑商品信息
- **状态更新**：修改小票状态（确认、标记重复等）
- **删除功能**：支持删除不需要的小票（含滑动删除）

#### 2.3 数据统计
- **月份统计**：按月份查看小票数量和总金额
- **分类统计**：查看各分类的消费情况
- **折叠/展开**：支持折叠和展开月份分组，便于浏览

---

### 3. 家庭管理 🏠

#### 3.1 创建家庭
- **新用户引导**：首次登录的用户可以创建新家庭
- **家庭信息**：
  - 家庭名称（必填）
  - 家庭地址（可选）
- **自动设置为当前家庭**：创建后自动成为家庭管理员

#### 3.2 家庭信息管理
- **编辑信息**：管理员可以修改家庭名称和地址
- **查看信息**：所有成员可以查看家庭基本信息

#### 3.3 切换家庭
- **多家庭支持**：用户可以是多个家庭的成员
- **快速切换**：在管理页面快速切换当前使用的家庭
- **创建新家庭**：在切换界面可以直接创建新家庭

---

### 4. 成员管理 👥

#### 4.1 成员列表
- **成员信息展示**：
  - 成员邮箱
  - 成员角色（管理员/普通成员）
  - 最后登录时间
- **管理员标识**：清晰标识家庭管理员

#### 4.2 邀请成员
- **邮件邀请**：通过邮箱地址邀请新成员加入家庭
- **邀请状态管理**：
  - 待处理 (Pending) - 等待用户接受
  - 已接受 (Accepted) - 用户已接受邀请
  - 已拒绝 (Declined) - 用户已拒绝邀请
  - 已取消 (Cancelled) - 邀请已取消
  - 已移除 (Removed) - 成员已被移除
- **唯一性保证**：每个家庭和邮箱组合只能有一条邀请记录

#### 4.3 移除成员
- **管理员权限**：只有管理员可以移除成员
- **自动清理**：移除成员时自动更新邀请状态为"已移除"
- **数据隔离**：移除后该成员无法再访问该家庭的数据

#### 4.4 处理邀请
- **邀请通知**：首页显示待处理邀请数量（邮件图标 + 数量）
- **邀请卡片**：美观的邀请卡片展示邀请信息
  - 邀请人邮箱（突出显示）
  - 家庭名称（清晰展示）
  - 当前/总数标识（如 "1/3"）
- **操作选项**：
  - **接受** - 接受邀请，加入家庭（绿色按钮，带图标）
  - **拒绝** - 拒绝邀请（红色边框按钮，带图标）
  - **稍后处理** - 暂时忽略邀请（灰色按钮，带图标）
- **多邀请处理**：
  - 层叠卡片效果展示多个待处理邀请
  - 左右箭头切换查看不同邀请
  - 依次处理，避免遗漏

---

### 5. 分类管理 🏷️

#### 5.1 分类列表
- **可视化展示**：每个分类显示名称和颜色标识
- **默认分类**：系统提供默认分类（如：购物、食品、家居等）

#### 5.2 分类操作
- **创建分类**：添加自定义分类，支持选择颜色
- **编辑分类**：修改分类名称和颜色
- **删除分类**：删除不需要的分类（不能删除默认分类）
- **合并分类**：将两个分类合并，统一商品归类

#### 5.3 分类应用
- **自动匹配**：AI 识别时自动匹配商品分类
- **手动调整**：在小票详情页可以手动修改商品分类

---

### 6. 用途管理 💼

#### 6.1 用途列表
- **用途定义**：定义商品的用途类型（如：个人、商务）
- **颜色标识**：每个用途有独特的颜色标识
- **默认用途**：系统提供默认用途

#### 6.2 用途操作
- **创建用途**：添加自定义用途，支持选择颜色
- **编辑用途**：修改用途名称和颜色
- **删除用途**：删除不需要的用途（不能删除默认用途）

#### 6.3 用途应用
- **商品标注**：为每个商品项设置用途
- **统计分类**：根据用途统计开支情况

---

### 7. 支付账户管理 💳

#### 7.1 账户列表
- **账户展示**：显示所有支付账户（如：现金、信用卡、支付宝等）
- **AI 识别标识**：标识哪些账户是 AI 自动识别的

#### 7.2 账户操作
- **创建账户**：手动添加支付账户
- **编辑账户**：修改账户名称
- **删除账户**：删除不需要的账户
- **合并账户**：合并重复的支付账户

#### 7.3 账户应用
- **自动识别**：AI 识别时自动匹配支付账户
- **手动选择**：在小票录入时手动选择支付账户

---

### 8. 个人资料管理 👤

#### 8.1 个人信息
- **姓名设置**：设置个人显示名称
- **邮箱显示**：显示注册邮箱（不可修改）

#### 8.2 账户操作
- **退出登录**：安全退出当前账户
- **数据缓存**：本地缓存个人信息，提升加载速度

---

## 技术特性

### 数据安全
- **Row Level Security (RLS)**：数据库级别的行级安全策略
- **家庭数据隔离**：确保用户只能访问所属家庭的数据
- **权限管理**：管理员和普通成员权限分离

### 实时同步
- **Supabase Realtime**：实时同步小票、分类、账户等数据变更
- **多设备同步**：同一账户在多设备上数据实时同步

### 离线支持
- **本地缓存**：关键数据本地缓存，提升加载速度
- **自动重试**：网络错误时自动重试操作

### 用户体验
- **响应式设计**：适配不同屏幕尺寸
- **流畅动画**：页面切换和操作都有流畅的动画效果
- **错误提示**：友好的错误提示和加载状态
- **操作确认**：重要操作（如删除）需要用户确认

---

## 数据模型

### 核心实体
- **小票 (Receipts)**：存储小票基本信息
- **商品项 (Receipt Items)**：存储小票中的商品明细
- **家庭 (Households)**：家庭基本信息
- **用户 (Users)**：用户个人信息
- **家庭成员关系 (User Households)**：用户与家庭的关系
- **邀请 (Household Invitations)**：成员邀请记录
- **分类 (Categories)**：商品分类
- **用途 (Purposes)**：商品用途
- **支付账户 (Payment Accounts)**：支付方式

---

## 权限说明

### 管理员权限
- 编辑家庭信息
- 邀请/移除成员
- 取消邀请
- 管理分类、用途、支付账户

### 普通成员权限
- 查看家庭信息
- 创建和编辑小票
- 管理个人分类、用途、支付账户（仅限自己创建的）

---

## 使用流程

### 新用户注册
1. 注册账户（邮箱 + 密码）
2. 创建或加入家庭
3. 开始使用应用

### 日常记账流程
1. 拍摄或选择小票照片
2. AI 自动识别（或手动录入）
3. 确认/编辑识别结果
4. 保存小票

### 邀请成员流程
1. 管理员在"成员管理"页面点击"邀请成员"
2. 输入成员邮箱地址
3. 发送邀请
4. 受邀用户收到邀请通知
5. 接受/拒绝邀请
6. 接受后自动加入家庭

---

## 注意事项

1. **网络连接**：首次使用和 AI 识别需要网络连接
2. **存储空间**：小票图片会占用云端存储空间，注意定期清理
3. **数据备份**：所有数据存储在云端（Supabase），自动备份
4. **隐私保护**：家庭数据仅家庭成员可见，系统不访问
5. **API 限制**：Gemini AI 有调用频率限制，请合理使用

---

## 支持与反馈

如有问题或建议，请联系开发团队。

---

*最后更新：2024年*
