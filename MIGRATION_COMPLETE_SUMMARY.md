# æ•°æ®åº“è¿ç§»å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„è¿ç§»æ­¥éª¤

### 1. è¡¨é‡å‘½å âœ…
- `households` â†’ `spaces`
- `stores` â†’ `suppliers`
- `user_households` â†’ `user_spaces`
- `store_merge_history` â†’ `supplier_merge_history`

### 2. åˆ—é‡å‘½å âœ…
- `household_id` â†’ `space_id` (æ‰€æœ‰ç›¸å…³è¡¨)
- `current_household_id` â†’ `current_space_id` (users è¡¨)
- `store_id` â†’ `supplier_id` (receipts è¡¨)
- `store_name` â†’ `supplier_name` (receipts è¡¨)
- `household_name` â†’ `space_name` (household_invitations è¡¨)

### 3. å”¯ä¸€çº¦æŸæ›´æ–° âœ…
- æ‰€æœ‰å”¯ä¸€çº¦æŸå·²æ›´æ–°ä¸ºä½¿ç”¨ `space_id` å’Œ `supplier_id`

### 4. å¤–é”®çº¦æŸæ›´æ–° âœ…
- æ‰€æœ‰å¤–é”®çº¦æŸå·²æ›´æ–°ä¸ºå¼•ç”¨æ–°è¡¨åå’Œåˆ—å

### 5. ç´¢å¼•æ›´æ–° âœ…
- æ‰€æœ‰ç´¢å¼•å·²æ›´æ–°ä¸ºä½¿ç”¨æ–°åˆ—å

### 6. RLS ç­–ç•¥æ›´æ–° âœ…
- æ‰€æœ‰ RLS ç­–ç•¥å·²æ›´æ–°ä¸ºä½¿ç”¨æ–°å‡½æ•°å’Œåˆ—å
- ä¿ç•™äº†å‘åå…¼å®¹çš„åˆ«åç­–ç•¥

### 7. æ•°æ®åº“å‡½æ•°æ›´æ–° âœ…
- åˆ›å»ºäº†æ‰€æœ‰æ–°å‡½æ•°ï¼ˆä½¿ç”¨ `space` å’Œ `supplier`ï¼‰
- ä¿ç•™äº†æ—§å‡½æ•°ä½œä¸ºåˆ«åï¼ˆå‘åå…¼å®¹ï¼‰
- åŒ…æ‹¬ï¼š
  - `get_user_space_id()` / `get_user_household_id()`
  - `create_space_with_user()` / `create_household_with_user()`
  - `is_admin_of_space()` / `is_admin_of_household()`
  - `check_space_has_admin()` / `check_household_has_admin()`
  - ç­‰ç­‰...

### 8. è§¦å‘å™¨æ›´æ–° âœ…
- `check_space_admin_trigger` å·²åˆ›å»ºå¹¶é…ç½®

## ğŸ“‹ æ‰§è¡Œçš„è„šæœ¬æ¸…å•

æŒ‰é¡ºåºæ‰§è¡Œäº†ä»¥ä¸‹è„šæœ¬ï¼š

1. âœ… `rename-household-to-space-and-store-to-supplier-fixed.sql` - è¡¨ã€åˆ—ã€çº¦æŸé‡å‘½å
2. âœ… `fix-remaining-columns.sql` - ä¿®å¤å‰©ä½™çš„åˆ—
3. âœ… `fix-remaining-constraints.sql` - ä¿®å¤å”¯ä¸€çº¦æŸ
4. âœ… `update-rls-policies.sql` - æ›´æ–° RLS ç­–ç•¥
5. âœ… `update-database-functions.sql` - æ›´æ–°æ•°æ®åº“å‡½æ•°
6. âœ… `update-missing-functions-simple.sql` - æ·»åŠ ç¼ºå¤±çš„å‡½æ•°

## ğŸ”„ å‘åå…¼å®¹æ€§

ä¸ºäº†ç¡®ä¿ç°æœ‰ä»£ç ä¸ä¼šç«‹å³ä¸­æ–­ï¼Œæˆ‘ä»¬ï¼š

1. **ä¿ç•™äº†æ‰€æœ‰æ—§å‡½æ•°ä½œä¸ºåˆ«å** - å®ƒä»¬è°ƒç”¨æ–°å‡½æ•°
2. **ä¿ç•™äº†æ—§ç­–ç•¥åç§°** - ä½¿ç”¨æ–°é€»è¾‘
3. **ä¿ç•™äº†æ—§è¡¨åå¼•ç”¨** - åœ¨å‡½æ•°å’Œç­–ç•¥ä¸­

## âš ï¸ ä¸‹ä¸€æ­¥ï¼šæ›´æ–°ä»£ç æ–‡ä»¶

æ•°æ®åº“è¿ç§»å·²å®Œæˆï¼Œç°åœ¨éœ€è¦æ›´æ–°ä»£ç æ–‡ä»¶ï¼š

### éœ€è¦æ›´æ–°çš„æ–‡ä»¶ç±»å‹ï¼š

1. **TypeScript ç±»å‹å®šä¹‰** âœ… (å·²å®Œæˆ)
   - `types/index.ts` - å·²æ›´æ–°

2. **æ ¸å¿ƒåº“æ–‡ä»¶** (éœ€è¦æ›´æ–°)
   - `lib/auth.ts` - éƒ¨åˆ†å·²æ›´æ–°ï¼Œéœ€è¦æ£€æŸ¥
   - `lib/database.ts` - éƒ¨åˆ†å·²æ›´æ–°ï¼Œéœ€è¦æ£€æŸ¥
   - `lib/suppliers.ts` - å·²æ›´æ–°
   - `lib/receipt-helpers.ts` - éƒ¨åˆ†å·²æ›´æ–°ï¼Œéœ€è¦æ£€æŸ¥
   - `lib/household-invitations.ts` - éƒ¨åˆ†å·²æ›´æ–°ï¼Œéœ€è¦æ£€æŸ¥
   - `lib/household-members.ts` - éƒ¨åˆ†å·²æ›´æ–°ï¼Œéœ€è¦æ£€æŸ¥

3. **é¡µé¢ç»„ä»¶** (éœ€è¦æ›´æ–°)
   - æ‰€æœ‰ä½¿ç”¨ `household` æˆ– `store` çš„é¡µé¢ç»„ä»¶
   - è·¯ç”±æ–‡ä»¶

4. **API è°ƒç”¨** (éœ€è¦æ›´æ–°)
   - æ‰€æœ‰ Supabase æŸ¥è¯¢
   - RPC å‡½æ•°è°ƒç”¨

## ğŸ§ª éªŒè¯è¿ç§»

è¿è¡Œä»¥ä¸‹è„šæœ¬éªŒè¯è¿ç§»æ˜¯å¦å®Œæ•´ï¼š

```sql
-- æ‰§è¡ŒéªŒè¯è„šæœ¬
-- verify-migration-complete.sql
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ—§å‡½æ•°å’Œç­–ç•¥å¯ä»¥ä¿ç•™** - å®ƒä»¬ä½œä¸ºåˆ«åå·¥ä½œæ­£å¸¸
2. **å»ºè®®é€æ­¥è¿ç§»ä»£ç ** - å…ˆæ›´æ–°æ ¸å¿ƒåŠŸèƒ½ï¼Œå†æ›´æ–° UI
3. **æµ‹è¯•æ¯ä¸ªåŠŸèƒ½** - ç¡®ä¿é‡å‘½åååŠŸèƒ½æ­£å¸¸
4. **å¯ä»¥åˆ é™¤æ—§åˆ«å** - å½“æ‰€æœ‰ä»£ç æ›´æ–°å®Œæˆåï¼ˆå¯é€‰ï¼‰

## ğŸ‰ æ­å–œï¼

æ•°æ®åº“è¿ç§»å·²æˆåŠŸå®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹æ›´æ–°ä»£ç æ–‡ä»¶äº†ã€‚
